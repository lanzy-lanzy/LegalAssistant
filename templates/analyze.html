{% extends 'base.html' %}
{% block content %}
<div class="animate-fade-in space-y-10" 
     x-data="{ 
        analyzing: false, 
        complete: {{ doc|yesno:'true,false' }}, 
        activeTab: 'summary',
        analysis: {},
        risks: [],
        zoomLevel: 100,
        init() {
            try {
                this.analysis = JSON.parse(document.getElementById('analysis-json').textContent);
                this.risks = this.analysis.risks || [];
            } catch (e) {
                console.error('Failed to parse analysis data', e);
            }
        },
        startAnalysis() {
            this.analyzing = true;
            setTimeout(() => {
                this.analyzing = false;
                this.complete = true;
                $dispatch('notify', 'Analysis complete! ' + (this.risks.length || 0) + ' risks identified.');
            }, 1000);
        },
        printAnalysis() {
            window.print();
        },
        zoomIn() { if(this.zoomLevel < 200) this.zoomLevel += 10; },
        zoomOut() { if(this.zoomLevel > 50) this.zoomLevel -= 10; }
    }">

    <!-- Hidden Data Storage -->
    <script id="analysis-json" type="application/json">
        {{ analysis_json|safe|default:'{}' }}
    </script>


    <!-- Top Action Bar -->
    <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 print:hidden">
        <div>
            <h1 class="text-3xl font-bold tracking-tight mb-2 text-white">Document Analysis</h1>
            <p class="text-slate-400">Current File: <span class="text-indigo-400 font-mono text-sm bg-indigo-500/10 px-2 py-1 rounded">{{ doc.title|default:'No File Selected' }}</span></p>
        </div>
        <div class="flex flex-wrap gap-4">
            <a href="/" class="px-6 py-2.5 rounded-xl border border-white/10 hover:bg-white/5 transition-all flex items-center gap-2 font-medium text-slate-300">
                <i class="fa-solid fa-arrow-left opacity-60"></i> Back to Dashboard
            </a>
            <button 
                class="px-8 py-2.5 rounded-xl bg-indigo-600 hover:bg-indigo-500 transition-all shadow-lg shadow-indigo-500/20 flex items-center gap-2 font-bold text-white disabled:opacity-50 disabled:cursor-not-allowed" 
                @click="startAnalysis" 
                :disabled="analyzing || complete"
            >
                <template x-if="!analyzing && !complete">
                    <span><i class="fa-solid fa-microchip mr-2"></i> Run AI Audit</span>
                </template>
                <template x-if="analyzing">
                    <span><i class="fa-solid fa-spinner fa-spin mr-2"></i> Analyzing...</span>
                </template>
                <template x-if="complete">
                    <span><i class="fa-solid fa-check mr-2"></i> Analysis Ready</span>
                </template>
            </button>
        </div>

    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
        <!-- Analysis Results -->
        <section class="lg:col-span-2 glass overflow-hidden flex flex-col min-h-[700px] print:w-full print:block">
            <!-- Custom Tabs -->
            <div class="flex gap-8 px-8 border-b border-white/5 bg-white/2 print:hidden">
                <template x-for="tab in [{id:'summary', label:'Executive Summary'}, {id:'risks', label:'Risk Matrix'}, {id:'clauses', label:'Smart Clauses'}]">
                    <button 
                        @click="activeTab = tab.id" 
                        class="py-5 font-semibold text-sm transition-all relative"
                        :class="activeTab === tab.id ? 'text-indigo-400' : 'text-slate-500 hover:text-slate-300'"
                    >
                        <span x-text="tab.label"></span>
                        <div x-show="activeTab === tab.id" class="absolute bottom-0 left-0 right-0 h-1 bg-indigo-500 rounded-t-full shadow-[0_-4px_10px_rgba(99,102,241,0.5)]"></div>
                    </button>
                </template>
            </div>

            <div class="p-8 flex-1 flex flex-col">
                <!-- Empty State / Analyzing -->
                <div x-show="!complete && !analyzing" class="flex-1 flex flex-col items-center justify-center text-center opacity-30 select-none print:hidden">
                    <div class="w-24 h-24 bg-white/5 rounded-full flex items-center justify-center mb-6">
                        <i class="fa-solid fa-file-shield text-5xl"></i>
                    </div>
                    <p class="text-xl font-medium mb-2">Ready for automated inspection</p>
                    <p class="text-sm">Our AI will scan for 42+ legal compliance parameters.</p>
                </div>

                <div x-show="analyzing" class="flex-1 flex flex-col items-center justify-center text-center print:hidden">
                    <div class="relative w-20 h-20 mb-8">
                        <div class="absolute inset-0 border-4 border-indigo-500/20 rounded-full"></div>
                        <div class="absolute inset-0 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
                    </div>
                    <p class="text-xl font-bold animate-pulse text-white">Scanning Contract Body...</p>
                    <p class="text-sm text-slate-500 mt-2">Correlating with jurisdictional precedents</p>
                </div>

                <!-- Results Content -->
                <div x-show="complete" class="animate-fade-in space-y-6">
                    <!-- Summary Tab -->
                    <div x-show="activeTab === 'summary' || window.matchMedia('print').matches" class="space-y-8">
                        <div class="p-8 bg-indigo-500/5 rounded-2xl border border-indigo-500/10 shadow-inner">
                            <div class="flex items-center gap-3 mb-4">
                                <i class="fa-solid fa-wand-magic-sparkles text-indigo-400 print:hidden"></i>
                                <h3 class="text-lg font-bold text-white tracking-tight">AI Insights Overview</h3>
                            </div>
                            <p class="text-slate-300 leading-relaxed" x-text="analysis.summary"></p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="p-6 glass border-white/5">
                                <h3 class="font-bold mb-4 text-slate-200 border-b border-white/5 pb-2 uppercase tracking-widest text-xs">Identified Milestones</h3>
                                <ul class="space-y-3">
                                    <template x-for="(dateItem, index) in (analysis.key_dates || [])" :key="index">
                                        <li class="flex items-center gap-3 text-sm">
                                            <i class="fa-solid fa-calendar text-indigo-400 w-5"></i>
                                            <span x-text="typeof dateItem === 'object' ? (Object.values(dateItem).join(': ')) : dateItem"></span>
                                        </li>
                                    </template>
                                    <template x-if="!(analysis.key_dates && analysis.key_dates.length)">
                                        <li class="text-slate-500 text-sm italic">No specific dates detected.</li>
                                    </template>
                                </ul>
                            </div>
                        </div>
                    </div>


                    <!-- Risks Tab -->
                    <div x-show="activeTab === 'risks' || window.matchMedia('print').matches" class="space-y-4">
                        <template x-for="(risk, index) in risks" :key="index">
                            <div class="p-5 glass border-l-4 transition-all hover:bg-white/10 group" 
                                 :class="{
                                    'border-l-rose-500': risk.severity === 'rose' || risk.severity === 'high',
                                    'border-l-amber-500': risk.severity === 'amber' || risk.severity === 'medium',
                                    'border-l-emerald-500': risk.severity === 'emerald' || risk.severity === 'low'
                                 }">
                                <div class="flex justify-between items-start mb-3">
                                    <span class="px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest" 
                                          :class="{
                                            'bg-rose-500/20 text-rose-400': risk.severity === 'rose' || risk.severity === 'high',
                                            'bg-amber-500/20 text-amber-400': risk.severity === 'amber' || risk.severity === 'medium',
                                            'bg-emerald-500/20 text-emerald-400': risk.severity === 'emerald' || risk.severity === 'low'
                                          }"
                                          x-text="risk.type"></span>
                                    <span class="text-[10px] font-mono text-slate-500 group-hover:text-slate-400 transition-colors" x-text="'REF: ' + risk.category"></span>
                                </div>
                                <p class="text-slate-300 text-sm leading-relaxed" x-text="risk.text"></p>
                            </div>
                        </template>
                        <template x-if="risks && risks.length === 0">
                            <div class="text-center py-20 opacity-30">
                                <i class="fa-solid fa-shield-check text-4xl mb-4 text-emerald-400"></i>
                                <p>No major risks detected.</p>
                            </div>
                        </template>
                    </div>
                    
                    <!-- Clauses Tab -->
                    <div x-show="activeTab === 'clauses' || window.matchMedia('print').matches" class="space-y-6">
                        <template x-for="(cl, index) in (analysis.clauses || [])" :key="index">
                            <div class="glass p-6 bg-slate-800/20 border-indigo-500/20">
                                <div class="flex items-center justify-between mb-4">
                                    <h4 class="text-xs font-black text-indigo-400 uppercase tracking-widest">Recommended Mitigation</h4>
                                    <span class="px-2 py-0.5 bg-emerald-500/10 text-emerald-400 text-[10px] rounded font-bold">SMART FIX</span>
                                </div>
                                <div class="relative group">
                                    <p class="text-sm font-mono bg-black/40 p-5 rounded-xl text-slate-300 leading-relaxed border border-white/5 italic" x-text="cl"></p>
                                    <button class="absolute top-4 right-4 text-slate-500 hover:text-indigo-400 transition-colors print:hidden" @click="$dispatch('notify', 'Clause copied!')">
                                        <i class="fa-solid fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                        </template>
                        <template x-if="!(analysis.clauses && analysis.clauses.length)">
                            <div class="text-center py-20 opacity-30">
                                <i class="fa-solid fa-scroll text-4xl mb-4"></i>
                                <p>No mitigation clauses available.</p>
                            </div>
                        </template>
                    </div>

                </div>
            </div>
        </section>

        <!-- Document Preview -->
        <section class="glass overflow-hidden flex flex-col h-[700px] border-indigo-500/10 print:hidden">
            <div class="p-5 border-b border-white/5 bg-white/2 flex justify-between items-center">
                <span class="font-bold text-xs tracking-widest uppercase opacity-50">Standard Viewer</span>
                <div class="flex gap-4">
                    <button class="text-slate-500 hover:text-indigo-400 transition-transform active:scale-95" @click="zoomOut()"><i class="fa-solid fa-magnifying-glass-minus"></i></button>
                    <span class="text-[10px] font-mono text-slate-600 self-center" x-text="zoomLevel + '%'"></span>
                    <button class="text-slate-500 hover:text-indigo-400 transition-transform active:scale-95" @click="zoomIn()"><i class="fa-solid fa-magnifying-glass-plus"></i></button>
                    <div class="w-px h-4 bg-white/10 self-center mx-1"></div>
                    <button class="text-slate-500 hover:text-rose-400 transition-colors" @click="printAnalysis()"><i class="fa-solid fa-print"></i></button>
                </div>
            </div>
            <div class="flex-1 p-10 overflow-y-auto font-serif text-slate-400 text-sm leading-loose bg-white/2 selection:bg-indigo-500/40">
                <div :style="`zoom: ${zoomLevel}%`" class="transition-all duration-200 origin-top">
                    <p class="mb-8 font-bold text-center uppercase tracking-widest text-slate-300" x-text="analysis.title || '{{ doc.title }}'"></p>
                    <div class="space-y-6">
                        <template x-if="analysis.extracted_text">
                            <p class="whitespace-pre-wrap font-mono text-[11px] opacity-70" x-text="analysis.extracted_text"></p>
                        </template>
                        <template x-if="!analysis.extracted_text">
                            <div class="space-y-4 opacity-50">
                                <p>Extracted document text will appear here after AI processing...</p>
                                <p class="h-4 bg-white/5 rounded w-3/4"></p>
                                <p class="h-4 bg-white/5 rounded w-1/2"></p>
                                <p class="h-4 bg-white/5 rounded w-5/6"></p>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </section>

    </div>
</div>
{% endblock content %}


